<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Training Plan</title>
  <link rel="stylesheet" href="themes.css" />
<script src="theme.js" defer></script>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
    }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.88);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{
      max-width:1100px;
      margin:0 auto;
      padding:var(--s3);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:var(--s3);
      flex-wrap:wrap;
    }
    .brand{display:flex; align-items:center; gap:var(--s2)}
    .logo{
      width:46px; height:46px;
      border-radius:16px;
      display:grid; place-items:center;
      font-weight:900;
      color:#fff;
      background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:var(--shadow2);
      user-select:none;
    }
    h1{margin:0; font-size:var(--t-lg); letter-spacing:.2px}
    .sub{margin-top:2px; font-size:var(--t-xs); color:var(--muted)}

    main{max-width:1100px; margin:0 auto; padding:var(--s3) var(--s3) 90px}

    .controls{display:flex; gap:var(--s2); flex-wrap:wrap; align-items:center}
    button, select, input{
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:800;
      box-shadow:var(--shadow2);
    }
    button{cursor:pointer}
    button:active{transform:translateY(1px)}

    .card{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r-lg);
      box-shadow:var(--shadow);
      padding:var(--s4);
      margin-top:var(--s3);
      display:flex;
      flex-direction:column;
      gap:var(--s3);
    }
    .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:var(--s3)}
    label{font-weight:900}
    small{color:var(--muted)}

    .week-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:var(--s3);
      padding:var(--s3);
      margin-top:var(--s3);
      border:1px solid rgba(15,23,42,0.06);
      border-radius:18px;
      background:linear-gradient(180deg, rgba(234,242,255,.85), #fff);
      box-shadow:var(--shadow2);
    }
    .row{display:flex; gap:var(--s2); align-items:center; flex-wrap:wrap}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); font-size:var(--t-xs)}
    .dot{width:10px; height:10px; border-radius:50%}
    .dot.done{background:var(--good)}
    .dot.skip{background:var(--warn)}
    .dot.todo{background:#cbd5e1}

    .days{display:flex; flex-direction:column; gap:var(--s3); margin-top:var(--s3)}
    .day{
      background:var(--panel);
      border:1px solid rgba(15,23,42,0.06);
      border-radius:18px;
      box-shadow:var(--shadow2);
      overflow:hidden;
      display:flex;
      min-height:140px;
    }
    @media (max-width: 860px){ .day{flex-direction:column} }
    .rail{
      flex:0 0 255px;
      padding:var(--s3);
      border-right:1px solid rgba(15,23,42,0.06);
      background:linear-gradient(180deg, rgba(226,238,255,.90), var(--panel));
      display:flex;
      flex-direction:column;
      gap:var(--s2);
    }
    @media (max-width: 860px){ .rail{border-right:none; border-bottom:1px solid var(--line)} }
    .dayname{font-weight:900}
    .tag{width:fit-content; font-size:var(--t-xs); padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:rgba(95,141,245,.12)}
    .body{flex:1; padding:var(--s3); display:flex; flex-direction:column; gap:14px}
    .blk{
      background:#f0f4ff;
      border:1px solid rgba(15,23,42,0.05);
      border-radius:14px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 1px 0 rgba(15,23,42,0.04), 0 6px 16px rgba(15,23,42,0.06);
    }
    .blk h3{margin:0; font-size:var(--t-md)}
    ul{margin:6px 0 0 18px}

    .btns{display:flex; gap:var(--s2); flex-wrap:wrap}
    .btn-small{box-shadow:none; padding:8px 10px; font-size:var(--t-xs)}
    .btn-done{border-color:rgba(16,185,129,.45)}
    .btn-skip{border-color:rgba(245,158,11,.45)}

    .hint{font-size:var(--t-xs); color:var(--muted)}

    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(2,6,23,.5);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:200;
    }
    .modal-backdrop.show{display:flex}
    .modal{
      width:min(780px, 100%);
      background:#fff;
      border-radius:var(--r-lg);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal header{
      position:unset;
      background:linear-gradient(135deg, rgba(95,141,245,.18), rgba(138,180,255,.12));
      border-bottom:1px solid var(--line);
    }
    .modal .hdr{
      padding:var(--s3);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:var(--s3);
    }
    .modal h2{margin:0; font-size:var(--t-lg)}
    .modal .content{padding:var(--s3); display:flex; flex-direction:column; gap:var(--s3)}
    .exercise{
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:var(--s2);
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:var(--s2);
      background:linear-gradient(180deg, rgba(240,244,255,.7), #fff);
    }
    @media (max-width: 720px){ .exercise{grid-template-columns:1fr} }
    .ex-title{font-weight:900}
    .ex-note{font-size:var(--t-xs); color:var(--muted)}
    .imgbox{
      width:100%;
      border-radius:var(--r-md);
      border:1px solid var(--line);
      background:#fff;
      display:grid;
      place-items:center;
      overflow:hidden;
      min-height:140px;
    }
    .imgbox img{width:100%; height:100%; object-fit:cover}

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#fff;
      border:1px solid var(--line);
      border-radius:var(--r-md);
      padding:10px 12px;
      box-shadow:var(--shadow);
      font-size:var(--t-xs);
      display:none;
      z-index:500;
    }
    .toast.show{display:block}

    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px; padding:2px 6px; border:1px solid var(--line); border-radius:8px; background:#fff}

    html[data-theme="dark"] .rail{
      background:linear-gradient(180deg, rgba(138,180,255,.12), var(--panel));
      border-right-color: rgba(255,255,255,0.08);
    }

    html[data-theme="dark"] .blk{
      background:rgba(138,180,255,.10);
      border-color: rgba(255,255,255,0.06);
    }

    html[data-theme="dark"] .week-meta{
      background:linear-gradient(180deg, rgba(138,180,255,.14), var(--panel));
      border-color: rgba(255,255,255,0.08);
    }

    html[data-theme="dark"] .day{
      border-color: rgba(255,255,255,0.08);
    }

    html[data-theme="dark"] button,
    html[data-theme="dark"] select,
    html[data-theme="dark"] input{
      background:var(--panel);
    }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">üèÄ</div>
      <div>
        <h1>My Training Plan</h1>
        <div class="sub">Strength + running fitness ‚Ä¢ cross trainer + skills ‚Ä¢ built for a 10-year-old athlete</div>
      </div>
    </div>
    <div class="controls">
      <button id="themeToggle" aria-pressed="false" aria-label="Toggle theme">üåô Dark</button>
      <button id="prevWeek" aria-label="Previous week">‚óÄ Week</button>
      <select id="weekSelect" aria-label="Select week"></select>
      <button id="nextWeek" aria-label="Next week">Week ‚ñ∂</button>
      <button id="reset">Reset</button>
    </div>
  </div>
</header>

<main>
  <div class="card">
    <div class="grid">
      <div>
        <label for="sessionLen">Session length</label>
        <select id="sessionLen">
          <option value="20">20 minutes</option>
          <option value="25" selected>25 minutes</option>
          <option value="30">30 minutes</option>
          <option value="35">35 minutes</option>
          <option value="40">40 minutes</option>
        </select>
        <div><small>Shorter is OK. We want quality + fun.</small></div>
      </div>
      <div>
        <label for="season">Season</label>
        <select id="season">
          <option value="in" selected>In-season (basketball/netball on)</option>
          <option value="off">Off-season (more running focus)</option>
        </select>
        <div><small>In-season = less running intensity.</small></div>
      </div>
      <div>
        <label for="effort">Effort rule</label>
        <select id="effort">
          <option value="easy" selected>Easy‚Äìmoderate (recommended)</option>
          <option value="mod">Moderate</option>
        </select>
        <div><small>No max testing. Stop while still fast.</small></div>
      </div>
      <div>
        <label>Coach rules</label>
        <div class="hint">
          ‚úÖ Technique first ‚Ä¢ ‚úÖ no pain ‚Ä¢ ‚úÖ stop before sloppy reps  
          <br/>Progress: add <span class="kbd">1‚Äì2 reps</span> or <span class="kbd">+2 min</span> before adding intensity.
        </div>
      </div>
    </div>
  </div>

  <div class="week-meta" id="weekMeta"></div>
  <div class="days" id="days"></div>
</main>

<!-- Exercise modal -->
<div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true" aria-label="Exercise details">
  <div class="modal">
    <header>
      <div class="hdr">
        <div>
          <h2 id="modalTitle">Exercises</h2>
          <div class="sub" id="modalSub">Tap outside to close.</div>
        </div>
        <button id="closeModal" class="btn-small" aria-label="Close">Close</button>
      </div>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script type="module">
  import { ISLA_PLAN } from "./plans/isla.plan.js";
  // ---- storage
  const KEY_SETTINGS = "kid_plan_settings_v1";
  const KEY_STATUS   = "kid_plan_status_v1"; // per week/day

  // ---- weeks
  const TOTAL_WEEKS = ISLA_PLAN.totalWeeks;

  function weekPhase(w){
    const phase = ISLA_PLAN.phases.find((p)=> w <= p.maxWeek) || ISLA_PLAN.phases[ISLA_PLAN.phases.length - 1];
    return { name: phase.name, note: phase.note };
  }

  // Rotate exercise variations so the plan changes week-to-week.
  // 0=A, 1=B, 2=C (repeat)
  function weekVariant(w){
    return (w - 1) % 3;
  }

  function variantLabel(v){
    return v === 0 ? "A" : v === 1 ? "B" : "C";
  }

  // ---- exercise library (images optional)
  const EX = ISLA_PLAN.exercises;

  // ---- plan builder (5‚Äì6 days + rest)
  function buildPlan(cfg){
    const inSeason = cfg.season === "in";
    const easy = cfg.effort === "easy";
    const len = Number(cfg.sessionLen);

    const phase = weekPhase(Number(cfg.week));
    const v = weekVariant(Number(cfg.week));

    const variations = ISLA_PLAN.variations;
    const keys = ISLA_PLAN.exerciseKeys;

    // ---- scaling (week-based progression)
    // Aerobic: +2 min each week within a phase, capped.
    const baseAerobic = clamp(len - 12, 12, 30);
    const aerobicBump = (phase.name === "Base") ? (cfg.week - 1) * 1 :
                        (phase.name === "Build") ? 4 + (cfg.week - 5) * 1 :
                        8 + (cfg.week - 9) * 1;
    const aerobicMain = clamp(baseAerobic + aerobicBump, 12, 30);

    // Strength rounds: Base 2‚Äì3, Build 3, Sharpen 3‚Äì4 depending on session length.
    let strengthRounds = len <= 25 ? 2 : len <= 35 ? 3 : 4;
    if (phase.name === "Base") strengthRounds = Math.min(strengthRounds, 3);
    if (phase.name === "Build") strengthRounds = Math.max(2, Math.min(strengthRounds, 3));
    if (phase.name === "Sharpen") strengthRounds = Math.max(3, strengthRounds);

    // Speed reps: fewer in-season; slightly more off-season; never to fatigue.
    let speedReps = inSeason ? 3 : 4;
    if (phase.name === "Base") speedReps = Math.min(speedReps, 3);
    if (phase.name === "Sharpen") speedReps = Math.min(speedReps + (inSeason ? 0 : 1), 5);

    // ---- weekly exercise variations (A/B/C)
    const squatVar = item(variations.squat[v], keys.squat);
    const pushVar = item(variations.push[v], keys.push);
    const balanceVar = item(variations.balance[v], keys.balance);
    const crawlVar = item(variations.crawl[v], keys.crawl);
    const coreVar = item(variations.core[v], keys.core);
    const hingeVar = item(variations.hinge[v], keys.hinge);
    const rowVar = item(variations.row[v], keys.row);
    const speedSet = (variations.speedSets[v] || []).map(({ text, exKey })=> item(fillTemplate(text, { reps: speedReps }), exKey));

    const values = {
      variant: variantLabel(v),
      phase: phase.name,
      strengthRounds,
      finishDrill: variations.finish[v],
      aerobicMain,
      aerobicWarmup: ISLA_PLAN.aerobic.warmup,
      aerobicCoolDown: ISLA_PLAN.aerobic.coolDown,
      aerobicSteadyNote: ISLA_PLAN.aerobic.steadyNote,
      seasonTag: inSeason ? "In-season" : "Off-season",
      splitSquat: variations.splitSquat[v],
      sidePlank: variations.sidePlank[v],
      deadBug: variations.deadBug[v],
      runWalk: inSeason ? ISLA_PLAN.runWalk.inSeason : (phase.name === "Sharpen" ? ISLA_PLAN.runWalk.sharpen : ISLA_PLAN.runWalk.build),
      crossTrainerTime: clamp(aerobicMain + 8, 20, 40),
      aerobicTag: inSeason ? "Easy" : "Build",
      funBlockTitle: inSeason ? ISLA_PLAN.funConditioning.titleInSeason : ISLA_PLAN.funConditioning.titleOffSeason,
      funRule: ISLA_PLAN.funConditioning.rule,
    };

    const refs = {
      items: { squatVar, pushVar, balanceVar, crawlVar, coreVar, hingeVar, rowVar },
      lists: { speedSet }
    };

    const { day1, day2, day3, day4, day5, day6, day7 } = ISLA_PLAN.days;

    const builtDay1 = buildDay(day1, values, refs);
    const builtDay2 = buildDay(day2, values, refs);
    const builtDay3 = buildDay(day3, values, refs);
    const builtDay4 = buildDay(day4, values, refs);
    const builtDay5 = buildDay(day5, values, refs);

    const extras = [];
    if (inSeason && easy){
      extras.push(block(ISLA_PLAN.funConditioning.inSeasonNoteTitle, [
        item(ISLA_PLAN.funConditioning.inSeasonNote, "")
      ]));
    }

    const builtDay6 = buildDay(day6, values, refs, extras);
    const builtDay7 = buildDay(day7, values, refs);

    return [builtDay1, builtDay2, builtDay3, builtDay4, builtDay5, builtDay6, builtDay7];
  }

  // ---- helpers
  function fillTemplate(str, values){
    return String(str).replace(/\{(\w+)\}/g, (_, key)=> (key in values ? values[key] : `{${key}}`));
  }

  function buildBlocks(templates, values, refs){
    return templates.map((blk)=>{
      const title = fillTemplate(blk.title, values);
      const items = [];
      blk.items.forEach((entry)=>{
        if (entry.listRef && refs.lists[entry.listRef]){
          refs.lists[entry.listRef].forEach((it)=> items.push(it));
          return;
        }
        if (entry.ref && refs.items[entry.ref]){
          items.push(refs.items[entry.ref]);
          return;
        }
        items.push(item(fillTemplate(entry.text, values), entry.exKey || ""));
      });
      return block(title, items);
    });
  }

  function buildDay(template, values, refs, extraBlocks){
    const blocks = buildBlocks(template.blocks, values, refs);
    const prefix = extraBlocks && extraBlocks.length ? extraBlocks : [];
    return {
      day: template.day,
      focus: template.focus,
      tag: fillTemplate(template.tagTemplate, values),
      blocks: [...prefix, ...blocks]
    };
  }

  function block(title, items){ return { title, items }; }
  function item(text, exKey){
    // exKey = key into EX (optional)
    return { text, exKey: exKey || "" };
  }
  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  // ---- UI elements
  const elDays = document.getElementById("days");
  const elMeta = document.getElementById("weekMeta");
  const elWeek = document.getElementById("weekSelect");
  const prevBtn = document.getElementById("prevWeek");
  const nextBtn = document.getElementById("nextWeek");

  const elToast = document.getElementById("toast");
  const backdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalSub = document.getElementById("modalSub");
  const modalContent = document.getElementById("modalContent");
  const closeButton = document.getElementById("closeModal");
  let lastFocus = null;

  // ---- settings
  const settings = load(KEY_SETTINGS, {
    week: 1,
    sessionLen: "25",
    season: "in",
    effort: "easy"
  });

  // week select options
  for (let i = 1; i <= TOTAL_WEEKS; i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `Week ${i}`;
    elWeek.appendChild(opt);
  }

  // hydrate controls
  document.getElementById("sessionLen").value = settings.sessionLen;
  document.getElementById("season").value = settings.season;
  document.getElementById("effort").value = settings.effort;
  elWeek.value = String(settings.week);

  // control listeners
  document.getElementById("sessionLen").addEventListener("change", (e)=>{ settings.sessionLen = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved"); });
  document.getElementById("season").addEventListener("change", (e)=>{ settings.season = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved"); });
  document.getElementById("effort").addEventListener("change", (e)=>{ settings.effort = e.target.value; save(KEY_SETTINGS, settings); render(); toast("Saved"); });
  elWeek.addEventListener("change", (e)=>{ settings.week = Number(e.target.value); save(KEY_SETTINGS, settings); render(); });

  prevBtn.addEventListener("click", ()=>{
    settings.week = Math.max(1, settings.week - 1);
    elWeek.value = String(settings.week);
    save(KEY_SETTINGS, settings);
    render();
  });
  nextBtn.addEventListener("click", ()=>{
    settings.week = Math.min(TOTAL_WEEKS, settings.week + 1);
    elWeek.value = String(settings.week);
    save(KEY_SETTINGS, settings);
    render();
  });

  document.getElementById("reset").addEventListener("click", ()=>{
    if (!confirm("Reset all saved weeks + checkmarks?")) return;
    localStorage.removeItem(KEY_SETTINGS);
    localStorage.removeItem(KEY_STATUS);
    location.reload();
  });

  // modal controls
  if (closeButton) closeButton.addEventListener("click", closeModal);
  backdrop.addEventListener("click", (e)=>{ if (e.target === backdrop) closeModal(); });
  document.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeModal(); });

  function openModal(exKeys){
    lastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
    modalTitle.textContent = "Exercises";
    modalSub.textContent = "Pictures are optional. Add files under /assets/img/.";
    modalContent.innerHTML = "";

    exKeys.forEach((k)=>{
      if (!k || !EX[k]) return;
      const ex = EX[k];
      const box = document.createElement("div");
      box.className = "exercise";

      const cues = (ex.cues || []).map(c=>`<li>${escapeHtml(c)}</li>`).join("");
      const note = ex.note ? `<div class="ex-note">${escapeHtml(ex.note)}</div>` : "";

      const imgHtml = ex.img ?
        `<div class="imgbox"><img src="${escapeHtml(ex.img)}" alt="${escapeHtml(k)}" onerror="this.remove(); this.parentElement.textContent='Add image: ' + '${escapeHtml(ex.img)}'"/></div>`
        : `<div class="imgbox"><div class="hint">No image yet</div></div>`;

      box.innerHTML = `
        <div>
          <div class="ex-title">${escapeHtml(k)}</div>
          ${note}
          <ul>${cues}</ul>
        </div>
        ${imgHtml}
      `;
      modalContent.appendChild(box);
    });

    backdrop.classList.add("show");
    if (closeButton) closeButton.focus();
  }
  function closeModal(){
    backdrop.classList.remove("show");
    if (lastFocus && typeof lastFocus.focus === "function") lastFocus.focus();
  }

  // ---- status
  function statusKey(week){ return `w${week}`; }

  function setDayStatus(week, idx, val){
    const st = load(KEY_STATUS, {});
    const wk = statusKey(week);
    st[wk] = st[wk] || {};
    if (val === "todo") delete st[wk][idx];
    else st[wk][idx] = val;
    save(KEY_STATUS, st);
  }
  function getDayStatus(week, idx){
    const st = load(KEY_STATUS, {});
    const wk = statusKey(week);
    return (st[wk] || {})[idx] || "todo";
  }

  // ---- render
  function render(){
    const cfg = {
      week: Number(settings.week),
      sessionLen: settings.sessionLen,
      season: settings.season,
      effort: settings.effort
    };

    const phase = weekPhase(cfg.week);
    const plan = buildPlan(cfg);

    const atFirstWeek = cfg.week <= 1;
    const atLastWeek = cfg.week >= TOTAL_WEEKS;
    if (prevBtn){
      prevBtn.disabled = atFirstWeek;
      prevBtn.setAttribute("aria-disabled", String(atFirstWeek));
      prevBtn.title = atFirstWeek ? "You're at the first week" : "Go to previous week";
    }
    if (nextBtn){
      nextBtn.disabled = atLastWeek;
      nextBtn.setAttribute("aria-disabled", String(atLastWeek));
      nextBtn.title = atLastWeek ? "You've reached the final week" : "Go to next week";
    }

    // meta counts
    let done = 0, skip = 0;
    plan.forEach((_, i)=>{
      const s = getDayStatus(cfg.week, i);
      if (s === "done") done++;
      else if (s === "skip") skip++;
    });

    elMeta.innerHTML = `
      <div>
        <div style="font-weight:900;font-size:${cssNum(16)}px">Week ${cfg.week} ‚Ä¢ ${phase.name}</div>
        <div style="color:var(--muted); font-size:12px">${escapeHtml(phase.note)}</div>
      </div>
      <div class="row">
        <span class="pill"><span class="dot done"></span>Done: <b>${done}</b></span>
        <span class="pill"><span class="dot skip"></span>Skipped: <b>${skip}</b></span>
        <span class="pill"><span class="dot todo"></span>Planned: <b>${plan.length - done - skip}</b></span>
      </div>
    `;

    // days
    elDays.innerHTML = "";

    plan.forEach((d, idx)=>{
      const st = getDayStatus(cfg.week, idx);

      const dayEl = document.createElement("div");
      dayEl.className = "day";

      dayEl.innerHTML = `
        <div class="rail">
          <div class="dayname">${escapeHtml(d.day)}</div>
          <div style="font-weight:900">${escapeHtml(d.focus)}</div>
          <div class="tag">${escapeHtml(d.tag)}</div>
          <div class="hint">Target: ${escapeHtml(cfg.sessionLen)} min</div>
          <div class="btns">
            <button class="btn-small btn-done" data-action="done">Mark done</button>
            <button class="btn-small btn-skip" data-action="skip">Skip</button>
            <button class="btn-small" data-action="todo">Clear</button>
          </div>
          <div class="hint">Status: <b>${escapeHtml(st)}</b></div>
          <button class="btn-small" data-action="show">See exercises</button>
        </div>
        <div class="body"></div>
      `;

      const body = dayEl.querySelector(".body");
      d.blocks.forEach((b)=>{
        const blkEl = document.createElement("div");
        blkEl.className = "blk";
        blkEl.innerHTML = `
          <h3>${escapeHtml(b.title)}</h3>
          <ul>
            ${b.items.map(it=>{
              const suffix = it.exKey ? ` <span class=\"hint\">(${escapeHtml(it.exKey)})</span>` : "";
              return `<li>${escapeHtml(it.text)}${suffix}</li>`;
            }).join("")}
          </ul>
        `;
        body.appendChild(blkEl);
      });

      // button handlers
      dayEl.querySelectorAll("button").forEach((btn)=>{
        const action = btn.getAttribute("data-action");
        if (!action) return;
        btn.addEventListener("click", ()=>{
          if (action === "show"){
            const keys = [];
            d.blocks.forEach(b=>b.items.forEach(it=>{ if (it.exKey) keys.push(it.exKey); }));
            openModal(unique(keys));
            return;
          }
          setDayStatus(cfg.week, idx, action);
          toast(action === "todo" ? "Cleared" : (action === "done" ? "Nice work!" : "Okay ‚Äî recovery is training too."));
          render();
        });
      });

      elDays.appendChild(dayEl);
    });
  }

  // ---- utilities
  function unique(arr){ return Array.from(new Set(arr)); }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k, fallback){
    try{ const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : fallback; }
    catch{ return fallback; }
  }
  function toast(msg){
    elToast.textContent = msg;
    elToast.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>elToast.classList.remove("show"), 1400);
  }
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (c)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[c]));
  }
  function cssNum(n){ return Number(n) || 0; }

  render();
</script>
</body>
</html>
